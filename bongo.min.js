(function(b){var d={};b.indexedDB=b.indexedDB||b.mozIndexedDB||b.webkitIndexedDB||b.msIndexedDB;b.IDBTransaction=b.IDBTransaction||b.webkitIDBTransaction||b.msIDBTransaction;b.IDBKeyRange=b.IDBKeyRange||b.webkitIDBKeyRange||b.msIDBKeyRange;if(!b.indexedDB){throw"IndexedDB not supported"}d.Database={};d.Collection={};Object.defineProperties(d.Collection,{db:{enumerable:false,value:function(i){var h=1;var g=b.indexedDB.open(this.database.name,this.database.version);g.onerror=function(j){throw g.webkitErrorMessage||g.error.name};g.onsuccess=function(j){i(j.target.result)};g.onupgradeneeded=function(k){var j=k.target.result;this.database.collections.forEach(function(m){if(typeof m==="string"){m={name:m}}if(j.objectStoreNames.contains(m.name)){j.deleteObjectStore(m.name)}var l=j.createObjectStore(m.name,{keyPath:"_id",autoIncrement:false})});i(k.target.result)}.bind(this)}},insert:{enumerable:false,writable:false,value:function(g,h){if(!g._id){g._id=d.key()}this.db(function(){});this.db(function(i){var l=i.transaction([this.collectionName],"readwrite");var k=l.objectStore(this.collectionName);var j=k.add(g);j.onsuccess=function(m){h(m.target.error,m.target.result)}}.bind(this))}},save:{enumerable:false,writable:false,value:function(g,h){h=h||a;this.db(function(){});this.db(function(i){var m=i.transaction([this.collectionName],"readwrite");var l=m.objectStore(this.collectionName);var j=[];function k(o){if(typeof o==="undefined"){return}var n;if(!o._id){o._id=d.key();n=l.add(o);n.onsuccess=function(p){if(!p.target.error&&p.target.result){j.push(p.target.result)}}}else{n=l.get(o._id);n.onsuccess=function(q){var p;if(!q.target.result){console.log("insert");p=l.add(o)}else{o=f(q.target.result,o);p=l.put(o)}p.onerror=function(r){console.log(r)};p.onsuccess=function(r){if(!r.target.error&&r.target.result){j.push(r.target.result)}}}}}if(g instanceof Array){g.forEach(function(n){k(n)})}else{k(g)}m.oncomplete=function(){h(null,j)}}.bind(this))}},count:{enumerable:false,writable:false,value:function(g){this.db(function(){});this.db(function(h){var k=h.transaction([this.collectionName],"readonly");var j=k.objectStore(this.collectionName);var i=j.count();i.onsuccess=function(l){g(l.target.error,l.target.result)}}.bind(this))}},remove:{enumerable:false,writable:false,value:function(h,g){this.db(function(){});this.db(function(i){var l=i.transaction([this.collectionName],"readwrite");var k=l.objectStore(this.collectionName);var j=k["delete"](h);j.onsuccess=function(m){g(m.target.error)}}.bind(this))}},get:{enumerable:false,writable:false,value:function(h,g){this.db(function(){});this.db(function(i){var l=i.transaction([this.collectionName],"readonly");var k=l.objectStore(this.collectionName);var j=k.get(h);j.onsuccess=function(m){g(m.target.error,m.target.result)}}.bind(this))}},find:{enumerable:false,writable:false,value:function(h,g){this.db(function(){});this.db(function(i){var m=i.transaction([this.collectionName],"readonly");var k=m.objectStore(this.collectionName);var l=Object.keys(h);var j=[];k.openCursor().onsuccess=function(p){if(p.target.error){return g(p.target.error)}var q=p.target.result;if(q){if(!l.length){j.push(q.value)}else{var n=true;var o;for(o in l){if(!(q.value[l[o]]&&q.value[l[o]]===h[l[o]])){n=false}}if(n){j.push(q.value)}}q["continue"]()}else{g(null,j)}}}.bind(this))}}});d.key=function(){var h=Math.floor(new Date().valueOf()/1000).toString(16);if(!this.key_m){this.key_m=Math.floor(Math.random()*(16777216)).toString(16)}if(!this.key_p){this.key_p=Math.floor(Math.random()*(32767)).toString(16)}if(typeof this.key_i==="undefined"){this.key_i=0}else{if(this.key_i>16777215){this.key_i=0}}this.key_i=Number(this.key_i);this.key_i++;var g=this.key_i.toString(16);var j="00000000".substr(0,6-h.length)+h+"000000".substr(0,6-this.key_m.length)+this.key_m+"0000".substr(0,4-this.key_p.length)+this.key_p+"000000".substr(0,6-g.length)+g;return j};var a=function(){};var f=function(g,i){g=g||{};for(var h in i){if(i.hasOwnProperty(h)){g[h]=i[h]}}return g};var c=function(){var h=new Date();h.setHours(0,0,0,0);var g=(h.getDay()+6)%7;return new Date(h-g*24*60*60*1000)};function e(h){var g=Object.create(h.prototype||null);Object.keys(h).map(function(j){g[j]=h[j]});return g}d.db=function(i,h){if(typeof i==="string"){i={name:i}}if(!i.name){b.console.log("Database name missing.");return false}if(typeof h!=="undefined"&&h instanceof Array){i.collections=h}i=e(i);if(typeof i.version==="undefined"){var g;g=c();i.version=g}if(i.version instanceof Date){i.version=Math.round(i.version.getTime())}if(typeof d[i.name]!=="undefined"&&i.version===d[i.name].version){return d[i.name]}i.collections.forEach(function(j){if(typeof j==="string"){j={name:j}}Object.defineProperty(i,j.name,{enumerable:false,value:Object.create(d.Collection,{collectionName:{value:j.name,enumerable:false,writable:false},database:{value:i,enumerable:false}})})});d[i.name]=i;return i};b.bongo=d}(self));