(function(a){function f(a){var b=Object.create(a.prototype||null);return Object.keys(a).map(function(c){b[c]=a[c]}),b}"use strict";var b={};a.indexedDB=a.indexedDB||a.mozIndexedDB||a.webkitIndexedDB||a.msIndexedDB,a.IDBTransaction=a.IDBTransaction||a.webkitIDBTransaction||a.msIDBTransaction,a.IDBKeyRange=a.IDBKeyRange||a.webkitIDBKeyRange||a.msIDBKeyRange;if(!a.indexedDB)throw"IndexedDB not supported";b.Database={},b.Collection={},Object.defineProperties(b.Collection,{db:{enumerable:!1,value:function(b){var c=1,d=a.indexedDB.open(this.database.name,this.database.version);d.onerror=function(a){throw d.webkitErrorMessage||d.error.name},d.onsuccess=function(a){b(a.target.result)},d.onupgradeneeded=function(a){var c=a.target.result;this.database.collections.forEach(function(a){typeof a=="string"&&(a={name:a}),c.objectStoreNames.contains(a.name)&&c.deleteObjectStore(a.name);var b=c.createObjectStore(a.name,{keyPath:"_id",autoIncrement:!1})}),b(a.target.result)}.bind(this)}},insert:{enumerable:!1,writable:!1,value:function(a,c){a._id||(a._id=b.key()),this.db(function(){}),this.db(function(b){var d=b.transaction([this.collectionName],"readwrite"),e=d.objectStore(this.collectionName),f=e.add(a);f.onsuccess=function(a){c(a.target.error,a.target.result)}}.bind(this))}},save:{enumerable:!1,writable:!1,value:function(a,e){e=e||c,this.db(function(){}),this.db(function(c){function i(a){if(typeof a=="undefined")return;var c;a._id?(c=g.get(a._id),c.onsuccess=function(b){var c;b.target.result?(a=d(b.target.result,a),c=g.put(a)):(console.log("insert"),c=g.add(a)),c.onerror=function(a){console.log(a)},c.onsuccess=function(a){!a.target.error&&a.target.result&&h.push(a.target.result)}}):(a._id=b.key(),c=g.add(a),c.onsuccess=function(a){!a.target.error&&a.target.result&&h.push(a.target.result)})}var f=c.transaction([this.collectionName],"readwrite"),g=f.objectStore(this.collectionName),h=[];a instanceof Array?a.forEach(function(a){i(a)}):i(a),f.oncomplete=function(){e(null,h)}}.bind(this))}},count:{enumerable:!1,writable:!1,value:function(a){this.db(function(){}),this.db(function(b){var c=b.transaction([this.collectionName],"readonly"),d=c.objectStore(this.collectionName),e=d.count();e.onsuccess=function(b){a(b.target.error,b.target.result)}}.bind(this))}},remove:{enumerable:!1,writable:!1,value:function(a,b){this.db(function(){}),this.db(function(c){var d=c.transaction([this.collectionName],"readwrite"),e=d.objectStore(this.collectionName),f=e.delete(a);f.onsuccess=function(a){b(a.target.error)}}.bind(this))}},get:{enumerable:!1,writable:!1,value:function(a,b){this.db(function(){}),this.db(function(c){var d=c.transaction([this.collectionName],"readonly"),e=d.objectStore(this.collectionName),f=e.get(a);f.onsuccess=function(a){b(a.target.error,a.target.result)}}.bind(this))}},find:{enumerable:!1,writable:!1,value:function(a,b){this.db(function(){}),this.db(function(c){var d=c.transaction([this.collectionName],"readonly"),e=d.objectStore(this.collectionName),f=Object.keys(a),g=[];e.openCursor().onsuccess=function(c){if(c.target.error)return b(c.target.error);var d=c.target.result;if(d){if(!f.length)g.push(d.value);else{var e=!0,h;for(h in f)d.value[h]&&d.value[h]!==a[h]&&(e=!1);e&&g.push(d.value)}d.continue()}else b(null,g)}}.bind(this))}}}),b.key=function(){var a=Math.floor((new Date).valueOf()/1e3).toString(16);this.key_m||(this.key_m=Math.floor(Math.random()*16777216).toString(16)),this.key_p||(this.key_p=Math.floor(Math.random()*32767).toString(16)),typeof this.key_i=="undefined"?this.key_i=0:this.key_i>16777215&&(this.key_i=0),this.key_i=Number(this.key_i),this.key_i++;var b=this.key_i.toString(16),c="00000000".substr(0,6-a.length)+a+"000000".substr(0,6-this.key_m.length)+this.key_m+"0000".substr(0,4-this.key_p.length)+this.key_p+"000000".substr(0,6-b.length)+b;return c};var c=function(){},d=function(a,b){a=a||{};for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},e=function(){var a=new Date;a.setHours(0,0,0,0);var b=(a.getDay()+6)%7;return new Date(a-b*24*60*60*1e3)};b.db=function(c,d){typeof c=="string"&&(c={name:c});if(!c.name)return a.console.log("Database name missing."),!1;typeof d!="undefined"&&d instanceof Array&&(c.collections=d),c=f(c);if(typeof c.version=="undefined"){var g;g=e(),c.version=g}return c.version instanceof Date&&(c.version=Math.round(c.version.getTime())),typeof b[c.name]!="undefined"&&c.version===b[c.name].version?b[c.name]:(c.collections.forEach(function(a){typeof a=="string"&&(a={name:a}),Object.defineProperty(c,a.name,{enumerable:!1,value:Object.create(b.Collection,{collectionName:{value:a.name,enumerable:!1,writable:!1},database:{value:c,enumerable:!1}})})}),b[c.name]=c,c)},a.bongo=b})(self)