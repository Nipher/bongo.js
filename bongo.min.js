(function(e){"use strict";function s(e){var t=Object.create(e.prototype||null);Object.keys(e).map(function(n){t[n]=e[n]});return t}var t={};e.indexedDB=e.indexedDB||e.mozIndexedDB||e.webkitIndexedDB||e.msIndexedDB;e.IDBTransaction=e.IDBTransaction||e.webkitIDBTransaction||e.msIDBTransaction;e.IDBKeyRange=e.IDBKeyRange||e.webkitIDBKeyRange||e.msIDBKeyRange;if(!e.indexedDB){throw"IndexedDB not supported"}t.Database={};t.Collection={};Object.defineProperties(t.Collection,{db:{enumerable:false,value:function(t){var n=1;var r=e.indexedDB.open(this.database.name,this.database.version);r.onerror=function(e){throw r.webkitErrorMessage||r.error.name};r.onsuccess=function(e){t(e.target.result)};r.onupgradeneeded=function(e){var n=e.target.result;this.database.collections.forEach(function(e){if(typeof e==="string"){e={name:e}}if(n.objectStoreNames.contains(e.name)){n.deleteObjectStore(e.name)}var t=n.createObjectStore(e.name,{keyPath:"_id",autoIncrement:false})});t(e.target.result)}.bind(this)}},insert:{enumerable:false,writable:false,value:function(e,n){if(!e._id){e._id=t.key()}this.db(function(){});this.db(function(t){var r=t.transaction([this.collectionName],"readwrite");var i=r.objectStore(this.collectionName);var s=i.add(e);s.onsuccess=function(e){n(e.target.error,e.target.result)}}.bind(this))}},save:{enumerable:false,writable:false,value:function(e,i){i=i||n;this.db(function(){});this.db(function(n){function a(e){var n;if(!e._id){e._id=t.key();n=o.add(e);n.onsuccess=function(e){if(!e.target.error&&e.target.result){u.push(e.target.result)}}}else{n=o.get(e._id);n.onsuccess=function(t){e=r(t.target.result,e);var n=o.put(e,e._id);n.onsuccess=function(e){if(!e.target.error&&e.target.result){u.push(e.target.result)}}}}}var s=n.transaction([this.collectionName],"readwrite");var o=s.objectStore(this.collectionName);var u=[];if(e instanceof Array){e.forEach(function(e){a(e)})}else{a(e)}s.oncomplete=function(){i(null,u)}}.bind(this))}},count:{enumerable:false,writable:false,value:function(e){this.db(function(){});this.db(function(t){var n=t.transaction([this.collectionName],"readonly");var r=n.objectStore(this.collectionName);var i=r.count();i.onsuccess=function(t){e(t.target.error,t.target.result)}}.bind(this))}},remove:{enumerable:false,writable:false,value:function(e,t){this.db(function(){});this.db(function(n){var r=n.transaction([this.collectionName],"readwrite");var i=r.objectStore(this.collectionName);var s=i.delete(e);s.onsuccess=function(e){t(e.target.error)}}.bind(this))}},get:{enumerable:false,writable:false,value:function(e,t){this.db(function(){});this.db(function(n){var r=n.transaction([this.collectionName],"readonly");var i=r.objectStore(this.collectionName);var s=i.get(e);s.onsuccess=function(e){t(e.target.error,e.target.result)}}.bind(this))}},find:{enumerable:false,writable:false,value:function(e,t){this.db(function(){});this.db(function(n){var r=n.transaction([this.collectionName],"readonly");var i=r.objectStore(this.collectionName);var s=Object.keys(e);var o=[];i.openCursor().onsuccess=function(n){if(n.target.error){return t(n.target.error)}var r=n.target.result;if(r){if(!s.length){o.push(r.value)}else{var i=false;s.forEach(function(t){if(r.value[t]&&r.value[t]===e[t]){o.push(r.value)}})}r.continue()}else{t(null,o)}}}.bind(this))}}});t.key=function(){var e=Math.floor((new Date).valueOf()/1e3).toString(16);if(!this.key_m){this.key_m=Math.floor(Math.random()*16777216).toString(16)}if(!this.key_p){this.key_p=Math.floor(Math.random()*32767).toString(16)}if(typeof this.key_i==="undefined"){this.key_i=0}else if(this.key_i>16777215){this.key_i=0}this.key_i=Number(this.key_i);this.key_i++;var t=this.key_i.toString(16);var n="00000000".substr(0,6-e.length)+e+"000000".substr(0,6-this.key_m.length)+this.key_m+"0000".substr(0,4-this.key_p.length)+this.key_p+"000000".substr(0,6-t.length)+t;return n};var n=function(){};var r=function(e,t){e=e||{};for(var n in t){if(t.hasOwnProperty(n)){e[n]=t[n]}}return e};var i=function(){var e=new Date;e.setHours(0,0,0,0);var t=(e.getDay()+6)%7;return new Date(e-t*24*60*60*1e3)};t.db=function(n,r){if(typeof n==="string"){n={name:n}}if(!n.name){e.console.log("Database name missing.");return false}if(typeof r!=="undefined"&&r instanceof Array){n.collections=r}n=s(n);if(typeof n.version==="undefined"){var o;var u=JSON.stringify(n);var a=e.localStorage.getItem("bongo-"+n.name);if(a&&(a=JSON.parse(a))&&u===JSON.stringify(a.definition)){o=parseInt(a.version,10)}else{o=i()}e.localStorage.setItem("bongo:"+n.name,JSON.stringify({definition:n,version:o}));n.version=o}if(n.version instanceof Date){n.version=Math.round(n.version.getTime())}if(typeof t[n.name]!=="undefined"&&n.version===t[n.name].version){return t[n.name]}n.collections.forEach(function(e){if(typeof e==="string"){e={name:e}}Object.defineProperty(n,e.name,{enumerable:false,value:Object.create(t.Collection,{collectionName:{value:e.name,enumerable:false,writable:false},database:{value:n,enumerable:false}})})});t[n.name]=n;return n};e.bongo=t})(window)