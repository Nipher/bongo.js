var bongo;(function(e){var t=function(){function t(t,n){n===void 0&&(n=function(){}),this.ensured=!1,this.objectStores=[],t.objectStores=t.objectStores||[],this.name=t.name;for(var o=0;t.objectStores.length>o;o++){"string"==typeof t.objectStores[o]&&(t.objectStores[o]={name:t.objectStores[o]});var r=new e.ObjectStore(this,t.objectStores[o]);this[r.name]=r,this.objectStores.push(r)}this.ensure(n)}return t.prototype.signature=function(){var e={};return this.objectStores.forEach(function(t){e[t.name]={autoIncrement:t.autoIncrement,indexes:t.indexes,keyPath:t.keyPath,name:t.name}}),{name:this.name,objectStores:e}},t.prototype.delete=function(t){t===void 0&&(t=function(){});for(var n=this,o=0,r=0;this.objectStores.length>r;r++)delete this[this.objectStores[r].name];delete this.objectStores;var i=function(){var r=e.indexedDB.deleteDatabase(n.name);r.onsuccess=function(){t()}.bind(n),r.onblocked=function(){if(!(40>o))throw r.webkitErrorMessage||r.error.name;setTimeout(function(){i(),o++},250)}.bind(n),r.onerror=function(){throw r.webkitErrorMessage||r.error.name}.bind(n)};this.get(function(e){e.close(),i()})},t.prototype.get=function(t){var n=this,o=500,r=function(){if(!n.ensured)return e.debug&&console.log("Database not ensured yet"),o--,o>0&&setTimeout(function(){r()},200),void 0;e.debug&&console.log("Database is ensured");var i=e.indexedDB.open(n.name);i.onupgradeneeded=function(){e.debug&&console.debug("onupgradeneeded");var t=i.result;t.close()},i.onsuccess=function(n){e.debug&&console.debug("onsuccess"),t(n.target.result)},i.onblocked=function(){throw console.log(n.version,i),console.log("onblocked"),i.webkitErrorMessage||i.error.name},i.onerror=function(){throw console.log("onerror"),i.webkitErrorMessage||i.error.name},i.onfailure=i.onerror};r()},t.prototype.ensure=function(t){t===void 0&&(t=function(){});var n=this;e.debug&&console.debug("Ensuring "+this.name),e.getStoredSignature(this.name,function(o){return e.equals(o,n.signature())?(e.getStoredVersion(n.name,function(e){n.version=e,t()}),n.ensured=!0,void 0):(e.getStoredVersion(n.name,function(r){n.version=r+1;var i=e.indexedDB.open(n.name,n.version);i.onblocked=function(){console.log("blocked",i.error.name)},i.onupgradeneeded=function(){for(var e=i.result,r=0;n.objectStores.length>r;r++)n.objectStores[r].ensureObjectStore(e);for(var s in o.objectStores)n[s]===void 0&&e.objectStoreNames.contains(s)&&e.deleteObjectStore(s);e.close(),setTimeout(function(){t()},1),n.ensured=!0}}),void 0)})},t}();e.Database=t})(bongo||(bongo={}));var bongo;(function(e){function t(){var e=Math.floor((new Date).valueOf()/1e3).toString(16);this.key_m||(this.key_m=Math.floor(16777216*Math.random()).toString(16)),this.key_p||(this.key_p=Math.floor(32767*Math.random()).toString(16)),this.key_i===void 0?this.key_i=0:this.key_i>16777215&&(this.key_i=0),this.key_i=Number(this.key_i),this.key_i++;var t=this.key_i.toString(16),n="00000000".substr(0,6-e.length)+e+"000000".substr(0,6-this.key_m.length)+this.key_m+"0000".substr(0,4-this.key_p.length)+this.key_p+"000000".substr(0,6-t.length)+t;return n}var n=function(){function t(e,t){this.database=e,this.name=t.name,this.keyPath=t.keyPath||"_id",this.autoIncrement=!!t.autoIncrement,this.indexes=t.indexes||[]}return t.prototype.filter=function(t){var n=new e.Query(this.database,[this.name]);return n.filter(t)},t.prototype.find=function(t){var n=new e.Query(this.database,[this.name]);return n.find(t)},t.prototype.findOne=function(t,n){var o=new e.Query(this.database,[this.name]);return o.findOne(t,n)},t.prototype.count=function(e,t){var n=this;t===void 0&&"function"==typeof e&&(t=[e,e=null][0]);var o,r=function(e){t(e.target.result)};this.database.get(function(e){var t=e.transaction([n.name],"readonly"),i=t.objectStore(n.name);o=i.count(),o.onsuccess=r}.bind(this))},t.prototype.ensureObjectStore=function(t){if(e.debug&&console.debug("ensureObjectStore"),!t.objectStoreNames||!t.objectStoreNames.contains(this.name)){e.debug&&console.debug("Creating "+this.name);var n=t.createObjectStore(this.name,{keyPath:"_id",autoIncrement:!1})}return n},t.prototype.get=function(e,t){e===void 0&&(e=""),t===void 0&&(t=function(){});var n=this;this.database.get(function(o){var r=o.transaction([n.name],"readonly"),i=r.objectStore(n.name),s=i.get(e);s.onsuccess=function(e){t(e.target.error,e.target.result)}}.bind(this))},t.prototype.remove=function(e,t){t===void 0&&(t=function(){});var n=this;this.database.get(function(o){var r,i=o.transaction([n.name],"readwrite"),s=i.objectStore(n.name);"string"==typeof e?r=s.delete(e):"{}"===JSON.stringify(e)&&(r=s.clear()),r.onsuccess=function(e){t(e.target.error,e.target.result)}},!0)},t.prototype.save=function(t,n){n===void 0&&(n=function(){});var o=this;t._id||(t._id=e.key()),this.database.get(function(e){var r=e.transaction(o.name,"readwrite"),i=r.objectStore(o.name),s=i.put(t);s.onsuccess=function(e){n(e.target.error,e.target.result)}},!0)},t.prototype.insert=function(t,n){n===void 0&&(n=function(){});var o=this;t._id||(t._id=e.key()),this.database.get(function(e){var r=e.transaction([o.name],"readwrite"),i=r.objectStore(o.name),s=i.add(t);s.onerror=function(e){console.log(e.target.error)},s.onsuccess=function(e){n(e.target.error,e.target.result)}},!0)},t.prototype.oldFind=function(t,n){var o=this,r=t.criteria||{},i=t.skip||0;this.database.get(function(s){var a=s.transaction([o.name],"readonly"),u=a.objectStore(o.name),c=[];t.sort&&(c=Object.keys(t.sort));var d=Object.keys(r);"boolean"==typeof r[d[0]]&&(r[d[0]]=r[d[0]]?1:0);var f,l,h,g=[];return 1===d.length&&u.indexNames&&u.indexNames.contains(d[0])?(h=function(e){if(e.target.error)return n(e.target.error);var o=e.target.result;return i>0?i--:o&&g.push(o.value),o&&(!t.limit||g.length<t.limit)?(o["continue"](),void 0):(n(null,g),void 0)},l=u.index(d[0]),f=e.IDBKeyRange.only(r[d[0]]),l.openCursor(f).onsuccess=h,void 0):(h=function(e){if(e.target.error)return n(e.target.error);var o=e.target.result;if(!o)return n(null,g),void 0;if(d.length){var s,a=!0;for(s in d)(o.value[d[s]]===void 0||o.value[d[s]]!==r[d[s]])&&(a=!1);a&&g.push(o.value)}else i>0?i--:o&&g.push(o.value);return!t.limit||g.length<t.limit?(o["continue"](),void 0):(n(null,g),void 0)},t.sort&&u.indexNames.contains(c[0])?(l=u.index(c[0]),1===t.sort[c[0]]?l.openCursor().onsuccess=h:l.openCursor(null,"prev").onsuccess=h,void 0):(u.openCursor().onsuccess=h,void 0))})},t}();e.ObjectStore=n,e.key=t})(bongo||(bongo={}));var bongo;(function(e){function t(e,t){for(var n={},o=0;t.length>o;o++)t[o]in e&&(n[t[o]]=e[t[o]]);return n}var n=function(){function e(e,t){this.database=e,this.objectStores=t,this._limit=100,this._skip=0,this.from=null,this.to=null,this.before=null,this.after=null,this.filters=[],this.keys=[]}return e.prototype.findOne=function(e,t){this.find(e).limit(1).toArray(function(e,n){return e?t(e):(n.length?t(e,n[0]):t(e,null),void 0)})},e.prototype.find=function(e){return e===void 0&&(e={}),this.filters.push(function(t){var n=!0;for(var o in e)if("string"==typeof e[o]&&(t[o]===void 0||t[o]!=e[o]))return!1;return n}),this},e.prototype.filter=function(e){return this.filters.push(e),this},e.prototype.skip=function(e){return this._skip=e,this},e.prototype.limit=function(e){return this._limit=e,this},e.prototype.pick=function(e){return this.keys=e,this},e.prototype.toArray=function(e){var n=this;this.database.get(function(o){var r=o.transaction(n.objectStores,"readonly"),i=r.objectStore(n.objectStores[0]),s=[],a=function(r){if(r.target.error)return o.close(),e(r.target.error);var i,a,u=r.target.result;if(!u)return o.close(),e(null,s),void 0;if(i=u.value,n.filters.length){a=!0;for(var c=0;n.filters.length>c;c++)n.filters[c](u.value)||(a=!1);a&&(n.keys.length&&(i=t(i,n.keys)),s.push(i))}else n._skip>0?n._skip--:(n.keys.length&&(i=t(i,n.keys)),s.push(i));return s.length<n._limit?(u.continue(),void 0):(o.close(),e(null,s),void 0)};i.openCursor().onsuccess=a})},e}();e.Query=n})(bongo||(bongo={}));var bongo;(function(e){function t(t,n){return n===void 0&&(n=function(){}),e[t.name]===void 0&&Object.defineProperty(e,t.name,{value:new e.Database(t,n)}),e[t.name]}function n(t,n){n===void 0&&(n=function(e){console.log(e)});var o=e.indexedDB.open(t);o.onsuccess=function(e){var t=e.target.result;t.close(),n(t.version)}}function o(t,n){n===void 0&&(n=function(e){console.log(e)});var o=e.indexedDB.open(t);o.onblocked=function(e){console.log("blocked",e)},o.onsuccess=function(e){var t,o,r,i=e.target.result,s=[],a={};for(t=0;i.objectStoreNames.length>t;t++)s.push(i.objectStoreNames.item(t));if(!s.length)return i.close(r),n({name:i.name,objectStores:a});var u=i.transaction(s,"readonly");s.forEach(function(e){var t=u.objectStore(e);o=[];for(var n=0;t.indexNames.length>n;n++)o.push(t.indexNames.item(n));a[e]={autoIncrement:t.autoIncrement,indexes:o,keyPath:t.keyPath,name:t.name}}),u.oncomplete=function(){return i.close(r),n({name:i.name,objectStores:a})}}}function r(e,t){var n;if(e===t)return!0;for(n in e)if(t[n]===void 0)return!1;for(n in t)if(e[n]===void 0)return!1;if(typeof e!=typeof t)return!1;if("object"!=typeof e)return e===t;for(n in e)if(e[n]){if("object"==typeof e[n]){if(!r(e[n],t[n]))return!1}else if(e[n]!==t[n])return!1}else if(t[n])return!1;return!0}function i(t){t===void 0&&(t=null),console.group("Bongo");var n,o=function(t){var n=e.indexedDB.open(t);n.onsuccess=function(e){for(var t=e.target.result,n=[],o=0;t.objectStoreNames.length>o;o++)n.push(t.objectStoreNames.item(o));console.log({name:t.name,objectStores:n,version:t.version})}};t?o(t):e.indexedDB.webkitGetDatabaseNames&&(n=e.indexedDB.webkitGetDatabaseNames(),n.onsuccess=function(e){for(var t=e.target.result,n=0;t.length>n;n++)o(t.item(n))}),console.groupEnd()}e.debug=!1,e.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,e.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,e.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,e.supported=!!e.indexedDB&&!!e.IDBTransaction&&!!e.IDBKeyRange,e.db=t,e.getStoredVersion=n,e.getStoredSignature=o,e.equals=r,e.info=i})(bongo||(bongo={}));